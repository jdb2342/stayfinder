// src/server.js

/**
 * [파일 설명]
 * 실제 서버를 시작(Start)하는 진입점 파일입니다.
 * app.js에서 정의한 로직을 가져와서,
 * 1. 데이터베이스에 먼저 연결하고 (authenticate)
 * 2. 데이터베이스 테이블을 코드 상태와 맞추고 (sync)
 * 3. 최종적으로 포트를 열어서 요청 대기 상태로 만듭니다 (listen).
 */

// ==========================================================
// 1. 모듈 및 설정 불러오기
// ==========================================================

// 우리가 app.js에서 열심히 설정한 Express 앱 객체를 가져옵니다.
// 아직 서버가 켜진 건 아니고, 설정만 잔뜩 담긴 상태입니다.
const app = require('./app');

// models/index.js 파일에서 내보낸 db 객체를 가져옵니다.
// 이 안에는 sequelize 접속 객체와, User, Listing 같은 모델들이 들어있습니다.
const db = require('./models');

// .env 파일의 환경변수를 불러옵니다. (포트 번호 등을 쓰기 위해)
require('dotenv').config();

// 서버가 실행될 포트 번호를 정합니다.
// .env 파일에 PORT가 있으면 그걸 쓰고, 없으면 4000번을 씁니다.
const PORT = process.env.PORT || 4000;

// ==========================================================
// 2. 서버 실행 로직 (비동기 처리)
// ==========================================================

// 데이터베이스 연결은 시간이 걸리는 '비동기 작업'입니다.
// 그래서 async 함수를 만들어서 즉시 실행(IIFE)하는 패턴을 사용합니다.
(async () => {
  try {
    // ------------------------------------------------------
    // 단계 1: DB 연결 확인
    // ------------------------------------------------------
    // 데이터베이스 접속 정보(유저, 비번, 호스트)가 맞는지 테스트합니다.
    // 만약 틀리면 여기서 에러가 나서 catch 블록으로 넘어갑니다.
    await db.sequelize.authenticate();
    
    // 연결 성공 시 로그 출력 (원본 코드 유지)
    console.log('DB connected');

    // ------------------------------------------------------
    // 단계 2: DB 테이블 동기화 (매우 중요)
    // ------------------------------------------------------
    // 코드로 작성한 모델(User, Listing 등)과 실제 MySQL 테이블 상태를 맞춥니다.
    // alter: true 옵션은 기존 데이터를 유지하면서 컬럼 변경사항을 반영합니다.
    await db.sequelize.sync({ alter: true }); // 개발 초기에는 alter/sync 사용

    // ------------------------------------------------------
    // 단계 3: 웹 서버 실행 (Listen)
    // ------------------------------------------------------
    // DB 연결이 확실히 성공한 후에야 서버를 엽니다.
    // 이제 브라우저나 포스트맨에서 http://localhost:4000 으로 요청을 보낼 수 있습니다.
    app.listen(PORT, () => {
      // 서버 실행 성공 로그 출력 (원본 코드 유지)
      console.log(`Server listening on port ${PORT}`);
    });

  } catch (err) {
    // ------------------------------------------------------
    // 에러 처리
    // ------------------------------------------------------
    // 위 단계 중 하나라도 실패하면(예: DB 비번 틀림, 포트 충돌) 여기가 실행됩니다.
    // 에러 로그 출력 (원본 코드 유지)
    console.error('Unable to start server', err);
  }
})();